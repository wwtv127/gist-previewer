<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gist Previewer & HTML Hoster</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* Base Styles */
    body { 
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; 
      background: #0d1117; 
      color: #c9d1d9; 
      margin: 0; 
      padding: 20px; 
    }

    /* Black Screen / Loading Mode Triggered via JS */
    body.loading-state { 
      background: #000 !important; 
    }
    body.loading-state #hosterForm, 
    body.loading-state h1,
    body.loading-state #output { 
      display: none !important; 
    }

    a { color: #58a6ff; text-decoration: none; }
    a:hover { text-decoration: underline; }

    h1, h2 { font-weight: bold; margin-bottom: 15px; }
    h1 { font-size: 2rem; }
    h2 { font-size: 1.4rem; margin-top: 40px; }

    .card { background: #161b22; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); margin-bottom: 30px; }

    textarea, input[type=password] { width: 100%; margin-top: 10px; padding: 10px; border-radius: 8px; border: none; background: #0d1117; color: #c9d1d9; font-family: monospace; font-size: 14px; }
    button { margin-top: 10px; padding: 12px 25px; border: none; border-radius: 8px; background: #238636; color: #fff; cursor: pointer; font-size: 14px; transition: background 0.2s; }
    button:hover { background: #2ea043; }

    label { font-size: 14px; margin-left: 8px; }

    #output pre { white-space: pre-wrap; word-wrap: break-word; background: #161b22; padding: 16px; border-radius: 8px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Gist Previewer & HTML Hoster</h1>

  <div id="hosterForm" class="card">
    <h2>Create Hosted HTML</h2>
    <textarea id="htmlInput" placeholder="Paste your HTML here..."></textarea>
    <input id="tokenInput" type="password" placeholder="GitHub Personal Access Token">
    <div style="margin-top:10px;">
      <input type="checkbox" id="rememberToken">
      <label for="rememberToken">Remember token</label>
    </div>
    <button id="createGistBtn">Create Hosted HTML</button>
    <div id="createdLink" style="margin-top:15px;"></div>
  </div>

  <div id="output"></div>

  <script>
    // --- 1. IMMEDIATE DETECTION ---
    // This runs before the rest of the UI logic to ensure a black screen instantly
    const params = new URLSearchParams(window.location.search);
    const gistUrl = params.get("gist");

    if (gistUrl) {
      document.body.classList.add('loading-state');
    }

    // --- 2. TOKEN MANAGEMENT ---
    const tokenInput = document.getElementById('tokenInput');
    const rememberCheckbox = document.getElementById('rememberToken');
    const storedToken = localStorage.getItem('gistPreviewerToken');
    if(storedToken) {
      tokenInput.value = storedToken;
      rememberCheckbox.checked = true;
    }

    // --- 3. HTML HOSTER LOGIC ---
    document.getElementById('createGistBtn').addEventListener('click', async () => {
      const htmlContent = document.getElementById('htmlInput').value;
      const token = tokenInput.value;
      const output = document.getElementById('createdLink');

      if (!htmlContent) { output.innerHTML = '<span style="color:red;">Please paste your HTML.</span>'; return; }
      if (!token) { output.innerHTML = '<span style="color:red;">Please provide your GitHub token.</span>'; return; }

      if(rememberCheckbox.checked) localStorage.setItem('gistPreviewerToken', token);
      else localStorage.removeItem('gistPreviewerToken');

      output.innerHTML = 'Creating gist…';

      try {
        const response = await fetch('https://api.github.com/gists', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'token ' + token
          },
          body: JSON.stringify({
            description: 'Hosted HTML via Gist Previewer',
            public: true,
            files: { 'index.html': { content: htmlContent } }
          })
        });

        const data = await response.json();
        if (!data.html_url) throw new Error('Failed to create gist');

        const previewerLink = `${window.location.origin}${window.location.pathname}?gist=${data.html_url}`;
        output.innerHTML = `✅ Hosted! Open here: <a href="${previewerLink}" target="_blank">${previewerLink}</a>`;
      } catch (err) {
        output.innerHTML = `<span style="color:red;">Error: ${err.message}</span>`;
      }
    });

    // --- 4. GIST PREVIEWER / BLACK SCREEN LOGIC ---
    const outputDiv = document.getElementById('output');

    if (gistUrl) {
      let gistId = null;
      let rawFilePath = null;

      // Extract ID
      if (gistUrl.includes("gist.githubusercontent.com")) {
        const parts = gistUrl.split("/");
        gistId = parts[4];
        rawFilePath = parts.slice(7).join("/");
      } else {
        const match = gistUrl.match(/gist.github.com\/[^/]+\/([a-f0-9]+)/i);
        if (match) gistId = match[1];
      }

      if (gistId) {
        fetch(`https://api.github.com/gists/${gistId}`)
          .then(res => res.json())
          .then(data => {
            let files = Object.values(data.files);
            if (rawFilePath) files = files.filter(f => f.filename === rawFilePath.split("/").pop());

            if (files.length === 0) {
              document.body.classList.remove('loading-state');
              return;
            }

            const file = files[0];
            if (file.filename.endsWith(".html")) {
              // document.write clears the loading-state and the entire page
              document.open();
              document.write(file.content);
              document.close();
            } else {
              // If it's code/text, reveal the UI and show the escaped code
              document.body.classList.remove('loading-state');
              outputDiv.innerHTML = "<pre>" + escapeHtml(file.content) + "</pre>";
            }
          })
          .catch(err => {
            // Revert to normal UI if there is an error so the user isn't stuck
            document.body.classList.remove('loading-state');
            console.error(err);
          });
      }
    }

    function escapeHtml(text) {
      return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }
  </script>
</body>
</html>
